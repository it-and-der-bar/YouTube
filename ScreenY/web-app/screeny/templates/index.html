{% extends "base.html" %}
{% block title %}Screeny – Dashboard{% endblock %}
{% block head %}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    /* Player Controls – dezente, moderne Buttons */
    .player-controls .btn-ctrl{
      --size: 36px;
      width: var(--size); height: var(--size);
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 10px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: #cfe3ff;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05), 0 2px 6px rgba(0,0,0,.25);
      transition: transform .06s ease, background .2s ease, border-color .2s ease, color .2s ease;
      padding: 0;
    }
    .player-controls .btn-ctrl:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      color: #fff;
    }
    .player-controls .btn-ctrl:active{ transform: translateY(1px) scale(.98); }
    .player-controls .btn-ctrl[disabled]{ opacity:.45; filter: grayscale(25%); cursor:not-allowed; }
    .player-controls .btn-ctrl.is-danger{
      color:#ffd1d1; border-color: rgba(255,0,0,.22);
    }
    .player-controls .btn-ctrl.is-danger:hover{
      background: rgba(255,0,0,.06); color:#fff;
    }
    .player-controls .btn-ctrl i{ font-size: 1.05rem; line-height: 1; }
    /* aktive Playlist-Reihe dezent hervorheben */
    .list-group-item.active2{ background: rgba(25,135,84,.08); }

    .list-group.playlists .list-group-item{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      color: #e7eefc;
      border-radius: 12px;
      margin-bottom: .5rem;
      display: flex; align-items: center; justify-content: space-between;
    }
    .list-group.playlists .list-group-item:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.14);
    }
    /* aktive Playlist deutlich, aber nicht grell */
    .list-group.playlists .list-group-item.active2{
      background: rgba(25,135,84,.12);
      border-color: rgba(25,135,84,.35);
      box-shadow: 0 0 0 2px rgba(25,135,84,.15) inset;
    }

  </style>

{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">ScreenY Web Player</div>
      <div class="card-body">
        <div class="d-flex align-items-center gap-3">
          <img id="player-thumb" alt="" class="rounded" style="width:64px;height:64px;object-fit:cover;background:#000;">
          <span class="badge text-bg-secondary" id="pl-mode-badge" style="width:100px">Repeat</span>
          <div class="player-controls d-flex gap-2 ms-auto">
            <button id="btn-prev" class="btn-ctrl" type="button" title="Zurück">
              <i class="bi bi-skip-backward-fill"></i>
            </button>
            <button id="btn-stop" class="btn-ctrl is-danger" type="button" title="Stop">
              <i class="bi bi-stop-fill"></i>
            </button>
            <button id="btn-next" class="btn-ctrl" type="button" title="Weiter">
              <i class="bi bi-skip-forward-fill"></i>
            </button>
          </div>
        </div>
        <div class="mt-2">
          <div><strong id="pl-name">–</strong> <span id="pl-count" class="text small"></span></div>
          <div id="pl-item" class="small text-break text">—</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">Playlists</div>
      <div class="card-body">
        <form class="d-flex mb-2" method="post" action="/playlist/create">
          <input class="form-control me-2" name="name" placeholder="Neue Playlist (Name)">
          <button class="btn btn-primary">Anlegen</button>
        </form>
        <ul class="list-group playlists">
          {% for p in playlists %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="/playlist/{{p}}/edit">{{p}}</a>
            <div class="player-controls d-flex gap-2">
              <form method="post" action="/playlist/{{p}}/start"><button class="btn-ctrl" type="submit" title="Start"><i class="bi bi-play-fill"></i></button></form>
              <form method="post" action="/playlist/{{p}}/stop"><button class="btn-ctrl is-danger" type="submit" title="Stop"><i class="bi bi-stop-fill"></i></button></form>
            </div>
          </li>
          {% endfor %}
          {% if not playlists %}<li class="list-group-item small text-muted">Noch keine Playlists.</li>{% endif %}
        </ul>
      </div>
    </div>
    <div class="card shadow-sm mt-3">
     <a class="btn btn-outline-primary" href="/media">Zur Medienverwaltung</a>
    </div>
  </div>

  <div class="col-lg-4">
   
    {% set tcfg = (cfg.get('tasmota') if cfg else {}) or {} %}
    {% if tcfg.get('enabled') %}
    <div class="card shadow-sm">
      <div class="card-header">Tasmota</div>
      <div class="card-body">
        <div class="d-flex align-items-center gap-3">
          <span id="power-dot" class="d-inline-block rounded-circle" style="width:12px;height:12px;background:#6c757d"></span>
          <span id="power-status" class="fw-semibold">OFFLINE</span>
          <div class="form-check form-switch ms-auto">
            <input class="form-check-input" type="checkbox" id="power-toggle">
            <label class="form-check-label" for="power-toggle">Power</label>
          </div>
        </div>
        <div id="power-energy" class="small text mt-2">Leistung: —</div>
      </div>
    </div>
    {% endif %}

<!-- NEU: Schaltuhr (tägliche Regeln) -->
        <div class="card shadow-sm mt-3" id="daily-rules-card">
          <div class="card-header d-flex align-items-center">
            <button class="btn btn-sm btn-link text-decoration-none p-0" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-daily-rules"
                    aria-expanded="false" aria-controls="collapse-daily-rules">
              ▸ Schaltuhr
            </button>
          </div>
          <div id="collapse-daily-rules" class="collapse">
            <div class="card-body">
              <form id="rule-form" class="row g-2 align-items-end mb-2">
                <div class="col-auto">
                  <label class="form-label mb-0 small">Zeit (HH:MM)</label>
                  <input type="time" class="form-control form-control-sm" id="rule-time" required>
                </div>
                <div class="col-auto">
                  <label class="form-label mb-0 small">Aktion</label>
                  <select class="form-select form-select-sm" id="rule-action">
                    <option value="ON">EIN</option>
                    <option value="OFF">AUS</option>
                  </select>
                </div>
                <div class="col-12"></div>
                <div class="col-auto">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="0" id="d-mo">
                    <label class="form-check-label" for="d-mo">Mo</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="1" id="d-di">
                    <label class="form-check-label" for="d-di">Di</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="2" id="d-mi">
                    <label class="form-check-label" for="d-mi">Mi</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="3" id="d-do">
                    <label class="form-check-label" for="d-do">Do</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="4" id="d-fr">
                    <label class="form-check-label" for="d-fr">Fr</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="5" id="d-sa">
                    <label class="form-check-label" for="d-sa">Sa</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" value="6" id="d-so">
                    <label class="form-check-label" for="d-so">So</label>
                  </div>
                </div>
                <div class="col-12 d-flex gap-2 mt-1">
                  <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-weekdays">Mo–Fr</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-weekends">Sa–So</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-all">Alle</button>
                  <button class="btn btn-sm btn-primary ms-auto" type="submit">Regel hinzufügen</button>
                </div>
              </form>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th style="width:110px">Zeit</th>
                      <th style="width:90px">Aktion</th>
                      <th>Tage</th>
                      <th style="width:100px"></th>
                    </tr>
                  </thead>
                  <tbody id="rules-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Timer (einfach) -->
        <div class="card shadow-sm mt-3" id="sched-card">
          <div class="card-header d-flex align-items-center">
            <button class="btn btn-sm btn-link text-decoration-none p-0" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-scheduler"
                    aria-expanded="false" aria-controls="collapse-scheduler">
              ▸ Timer einstellen
            </button>
          </div>
          <div id="collapse-scheduler" class="collapse">
            <div class="card-body">
              <div class="d-flex gap-2 flex-wrap mb-2">
                <button class="btn btn-outline-secondary btn-sm add-timer" data-hours="1" data-action="OFF">In 1h AUS</button>
                <button class="btn btn-outline-secondary btn-sm add-timer" data-hours="2" data-action="ON">In 2h EIN</button>
                <button class="btn btn-outline-secondary btn-sm add-timer" data-hours="4" data-action="OFF">In 4h AUS</button>
              </div>
              <div class="input-group input-group-sm mb-2" style="max-width:340px">
                <span class="input-group-text">In (h)</span>
                <input type="number" min="0.1" step="0.1" class="form-control" id="timer-hours" placeholder="z.B. 1.5">
                <button class="btn btn-outline-secondary" id="btn-add-on">→ EIN</button>
                <button class="btn btn-outline-secondary" id="btn-add-off">→ AUS</button>
              </div>

              <ul class="list-group" id="timer-list"></ul>
            </div>
          </div>
        </div>

  </div>
</div>
<script src="/static/js/screeny.js"></script>
{% endblock %}
